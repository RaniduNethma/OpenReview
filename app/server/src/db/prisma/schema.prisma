// Prisma Schema for OpenReview

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(cuid())
  githubId      Int      @unique
  username      String
  email         String?
  avatarUrl     String?
  
  repositories  Repository[]
  settings      UserSettings?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([githubId])
  @@map("users")
}

model UserSettings {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  mode          ReviewMode @default(BEGINNER)
  autoReview    Boolean    @default(true)
  maxFiles      Int        @default(50)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("user_settings")
}

model Repository {
  id            String   @id @default(cuid())
  githubId      Int      @unique
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  fullName      String
  private       Boolean  @default(false)
  
  pullRequests  PullRequest[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([githubId])
  @@map("repositories")
}

model PullRequest {
  id            String   @id @default(cuid())
  githubId      Int      @unique
  repositoryId  String
  repository    Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  
  number        Int
  title         String
  author        String
  branch        String
  
  status        PRStatus @default(PENDING)
  filesChanged  Int      @default(0)
  
  reviews       Review[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([repositoryId])
  @@index([githubId])
  @@index([status])
  @@map("pull_requests")
}

model Review {
  id            String   @id @default(cuid())
  pullRequestId String
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  
  mode          ReviewMode
  status        ReviewStatus @default(PENDING)
  
  findings      Finding[]
  
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  duration      Int?      // milliseconds
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([pullRequestId])
  @@index([status])
  @@map("reviews")
}

model Finding {
  id            String   @id @default(cuid())
  reviewId      String
  review        Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  
  type          FindingType
  severity      Severity
  
  file          String
  line          Int
  code          String   @db.Text
  
  message       String   @db.Text
  explanation   String   @db.Text
  suggestion    String?  @db.Text
  resources     String[] // URLs to learning materials
  
  commentId     Int?     // GitHub comment ID
  
  createdAt     DateTime @default(now())

  @@index([reviewId])
  @@index([type])
  @@index([severity])
  @@map("findings")
}

// Enums
enum ReviewMode {
  BEGINNER
  INTERMEDIATE
  SENIOR
}

enum PRStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum ReviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum FindingType {
  BUG
  SECURITY
  CODE_SMELL
  BEST_PRACTICE
  PERFORMANCE
  NAMING
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}